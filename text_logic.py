import os
from openai import OpenAI

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è OpenAI –∫–ª–∏–µ–Ω—Ç–∞
_openai_client = None

def get_openai_client():
    """–õ–µ–Ω–∏–≤–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è OpenAI –∫–ª–∏–µ–Ω—Ç–∞"""
    global _openai_client
    if _openai_client is None:
        api_key = os.getenv("OPENAI_API_KEY")
        if api_key:
            _openai_client = OpenAI(api_key=api_key)
    return _openai_client

def convert_to_plans_and_tasks(transcription: str) -> str:
    """
    –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ—Ç —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—é –≤—Å—Ç—Ä–µ—á–∏ –≤ —Ñ–æ—Ä–º–∞—Ç "–ø–ª–∞–Ω—ã –∏ –∑–∞–¥–∞—á–∏"
    """
    client = get_openai_client()
    
    if not client:
        # –ï—Å–ª–∏ –Ω–µ—Ç API –∫–ª—é—á–∞, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –ø—Ä–æ—Å—Ç—É—é –æ–±—Ä–∞–±–æ—Ç–∫—É
        return f"üìã –ü–ª–∞–Ω—ã –∏ –∑–∞–¥–∞—á–∏ –∏–∑ –≤—Å—Ç—Ä–µ—á–∏:\n\n{transcription}"
    
    try:
        response = client.chat.completions.create(
            model="gpt-4o-mini",
            messages=[
                {
                    "role": "system",
                    "content": (
                        "–¢—ã –≤—ã—Å—Ç—É–ø–∞–µ—à—å –∫–∞–∫ –ø—Ä–æ–¥–∂–µ–∫—Ç-–º–µ–Ω–µ–¥–∂–µ—Ä. –ù–∞ –æ—Å–Ω–æ–≤–µ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–∏ –≤—Å—Ç—Ä–µ—á–∏ "
                        "—Å—Ñ–æ—Ä–º–∏—Ä—É–π –ø–æ–Ω—è—Ç–Ω—ã–π –æ—Ç—á—ë—Ç, –∫–æ—Ç–æ—Ä—ã–π —Å–æ—Å—Ç–æ–∏—Ç –∏–∑ —Ç—Ä—ë—Ö –±–ª–æ–∫–æ–≤:\n"
                        "1. üìå –ö—Ä–∞—Ç–∫–æ–µ —Ä–µ–∑—é–º–µ (2-3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –æ —Ü–µ–ª–∏ –∏ —Å—Ç–∞—Ç—É—Å–µ).\n"
                        "2. ‚úÖ –ü—Ä–∏–Ω—è—Ç—ã–µ —Ä–µ—à–µ–Ω–∏—è/—Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω—ã–µ –º–æ–º–µ–Ω—Ç—ã (–±—É–ª–ª–µ—Ç—ã).\n"
                        "3. üß± –ü–ª–∞–Ω—ã –∏ –∑–∞–¥–∞—á–∏ (–∫–∞–∂–¥–∞—è —Å—Ç—Ä–æ–∫–∞ –≤ —Ñ–æ—Ä–º–∞—Ç–µ: ‚Ä¢ –ó–∞–¥–∞—á–∞ ‚Äî –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π ‚Äî —Å—Ä–æ–∫/—Å—Ç–∞—Ç—É—Å).\n"
                        "–£–∫–∞–∑—ã–≤–∞–π –∫–æ–Ω–∫—Ä–µ—Ç–∏–∫—É, –∏–∑–±–µ–≥–∞–π –±–µ—Å—Å–º—ã—Å–ª–µ–Ω–Ω—ã—Ö –ø—É–Ω–∫—Ç–æ–≤. –ï—Å–ª–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –Ω–µ—Ç ‚Äî —è–≤–Ω–æ –Ω–∞–ø–∏—à–∏ '–Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö'."
                    ),
                },
                {
                    "role": "user",
                    "content": (
                        "–°—Ñ–æ—Ä–º–∏—Ä—É–π –æ—Ç—á—ë—Ç –ø–æ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–∏ –Ω–∏–∂–µ. –ï—Å–ª–∏ –≤—Å—Ç—Ä–µ—á–∞ –Ω–µ –Ω–µ—Å—ë—Ç —Å–º—ã—Å–ª–∞ (—Ç–µ—Å—Ç, —à—É—Ç–∫–∏), "
                        "–Ω–∞–ø—Ä—è–º—É—é –Ω–∞–ø–∏—à–∏, —á—Ç–æ —Å–æ–¥–µ—Ä–∂–∞—Ç–µ–ª—å–Ω–æ–≥–æ –æ–±—Å—É–∂–¥–µ–Ω–∏—è –Ω–µ –±—ã–ª–æ.\n\n"
                        f"{transcription}"
                    ),
                },
            ],
            temperature=0.2,
            max_tokens=1000,
        )
        
        return response.choices[0].message.content
    except Exception as e:
        # –ï—Å–ª–∏ –æ—à–∏–±–∫–∞ —Å OpenAI, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—é —Å –±–∞–∑–æ–≤—ã–º —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ–º
        return f"üìã –ü–ª–∞–Ω—ã –∏ –∑–∞–¥–∞—á–∏ –∏–∑ –≤—Å—Ç—Ä–µ—á–∏:\n\n{transcription}\n\n(–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —á–µ—Ä–µ–∑ AI: {str(e)})"
